/*
 * Copyright 2009-2018 The VOTCA Development Team (http://www.votca.org)
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
#define BOOST_TEST_MAIN

#define BOOST_TEST_MODULE gnode_test
#include <boost/test/unit_test.hpp>
#include <votca/xtp/orbitals.h>
#include <votca/xtp/convergenceacc.h>

using namespace votca::xtp;

BOOST_AUTO_TEST_SUITE(orbitals_test)

BOOST_AUTO_TEST_CASE(densmatgs_test) {
  
  
  
  Orbitals orb;
  orb.setBasisSetSize(17);
  orb.setNumberOfLevels(4,13);
  
  Eigen::MatrixXd H=Eigen::MatrixXd::Zero(17,17);
  //generated from 3-21G with ecp on methane independent electron guess
  H<<13.2967782,-1.99797328,0,0,0,-0.26575698,0,0,0,-0.0909339466,-0.147466802,-0.0909339466,-0.147466802,-0.0909339466,-0.147466802,-0.0909339466,-0.147466802,
-1.99797328,-4.04412972,0,0,0,-3.49418055,0,0,0,-0.994581408,-1.89398582,-0.994581408,-1.89398582,-0.994581408,-1.89398582,-0.994581408,-1.89398582,
0,0,-3.93848515,0,0,0,-2.25634153,0,0,-0.780335933,-0.599314142,-0.780335933,-0.599314142,0.780335933,0.599314142,0.780335933,0.599314142,
0,0,0,-3.93848515,0,0,0,-2.25634153,0,-0.780335933,-0.599314142,0.780335933,0.599314142,0.780335933,0.599314142,-0.780335933,-0.599314142,
0,0,0,0,-3.93848515,0,0,0,-2.25634153,-0.780335933,-0.599314142,0.780335933,0.599314142,-0.780335933,-0.599314142,0.780335933,0.599314142,
-0.26575698,-3.49418055,0,0,0,-3.88216043,0,0,0,-1.38139383,-2.47288528,-1.38139383,-2.47288528,-1.38139383,-2.47288528,-1.38139383,-2.47288528,
0,0,-2.25634153,0,0,0,-3.02562938,0,0,-1.03641022,-0.99951947,-1.03641022,-0.99951947,1.03641022,0.99951947,1.03641022,0.99951947,
0,0,0,-2.25634153,0,0,0,-3.02562938,0,-1.03641022,-0.99951947,1.03641022,0.99951947,1.03641022,0.99951947,-1.03641022,-0.99951947,
0,0,0,0,-2.25634153,0,0,0,-3.02562938,-1.03641022,-0.99951947,1.03641022,0.99951947,-1.03641022,-0.99951947,1.03641022,0.99951947,
-0.0909339466,-0.994581408,-0.780335933,-0.780335933,-0.780335933,-1.38139383,-1.03641022,-1.03641022,-1.03641022,-3.00123345,-2.29509192,-0.0552940511,-0.512094198,-0.0552940511,-0.512094198,-0.0552940511,-0.512094198,
-0.147466802,-1.89398582,-0.599314142,-0.599314142,-0.599314142,-2.47288528,-0.99951947,-0.99951947,-0.99951947,-2.29509192,-2.99604761,-0.512094198,-1.30279378,-0.512094198,-1.30279378,-0.512094198,-1.30279378,
-0.0909339466,-0.994581408,-0.780335933,0.780335933,0.780335933,-1.38139383,-1.03641022,1.03641022,1.03641022,-0.0552940511,-0.512094198,-3.00123345,-2.29509192,-0.0552940511,-0.512094198,-0.0552940511,-0.512094198,
-0.147466802,-1.89398582,-0.599314142,0.599314142,0.599314142,-2.47288528,-0.99951947,0.99951947,0.99951947,-0.512094198,-1.30279378,-2.29509192,-2.99604761,-0.512094198,-1.30279378,-0.512094198,-1.30279378,
-0.0909339466,-0.994581408,0.780335933,0.780335933,-0.780335933,-1.38139383,1.03641022,1.03641022,-1.03641022,-0.0552940511,-0.512094198,-0.0552940511,-0.512094198,-3.00123345,-2.29509192,-0.0552940511,-0.512094198,
-0.147466802,-1.89398582,0.599314142,0.599314142,-0.599314142,-2.47288528,0.99951947,0.99951947,-0.99951947,-0.512094198,-1.30279378,-0.512094198,-1.30279378,-2.29509192,-2.99604761,-0.512094198,-1.30279378,
-0.0909339466,-0.994581408,0.780335933,-0.780335933,0.780335933,-1.38139383,1.03641022,-1.03641022,1.03641022,-0.0552940511,-0.512094198,-0.0552940511,-0.512094198,-0.0552940511,-0.512094198,-3.00123345,-2.29509192,
-0.147466802,-1.89398582,0.599314142,-0.599314142,0.599314142,-2.47288528,0.99951947,-0.99951947,0.99951947,-0.512094198,-1.30279378,-0.512094198,-1.30279378,-0.512094198,-1.30279378,-2.29509192,-2.99604761;
  Eigen::MatrixXd Smonehalf=Eigen::MatrixXd::Zero(17,17);
  Smonehalf<<1.02069513,-0.0475823997,1.73172172e-17,-6.50883919e-17,-6.52291395e-17,-0.141872887,2.16957311e-16,-9.52226329e-17,2.62558316e-16,0.0189158405,0.016640171,0.0189158405,0.016640171,0.0189158405,0.016640171,0.0189158405,0.016640171,
-0.0475823997,1.57735559,-3.07973614e-16,-6.85582468e-17,-2.61619206e-16,-1.22386876,1.40797092e-15,4.01862285e-18,4.16649736e-16,0.0212513743,0.142018507,0.0212513743,0.142018507,0.0212513743,0.142018507,0.0212513743,0.142018507,
1.73172172e-17,-3.07973614e-16,1.15607662,1.21430643e-17,-2.01227923e-16,6.56330495e-16,-0.385231782,4.85722573e-16,-2.22044605e-16,-0.0527255249,0.0677106203,-0.0527255249,0.0677106203,0.0527255249,-0.0677106203,0.0527255249,-0.0677106203,
-6.50883919e-17,-6.85582468e-17,-3.6429193e-17,1.15607662,-6.59194921e-17,2.10864442e-16,5.55111512e-16,-0.385231782,4.0939474e-16,-0.0527255249,0.0677106203,0.0527255249,-0.0677106203,0.0527255249,-0.0677106203,-0.0527255249,0.0677106203,
-6.52291395e-17,-2.61619206e-16,-1.73472348e-16,-1.00613962e-16,1.15607662,5.91756594e-16,-2.22044605e-16,4.30211422e-16,-0.385231782,-0.0527255249,0.0677106203,0.0527255249,-0.0677106203,-0.0527255249,0.0677106203,0.0527255249,-0.0677106203,
-0.141872887,-1.22386876,6.56330495e-16,2.10864442e-16,5.91756594e-16,4.13830531,-2.60049839e-15,-5.21089197e-16,-3.04895642e-16,-0.157316294,-0.871791449,-0.157316294,-0.871791449,-0.157316294,-0.871791449,-0.157316294,-0.871791449,
2.16957311e-16,1.40797092e-15,-0.385231782,5.89805982e-16,-2.22044605e-16,-2.60049839e-15,1.8375813,-1.37043155e-15,2.35922393e-16,-0.0683575456,-0.522232696,-0.0683575456,-0.522232696,0.0683575456,0.522232696,0.0683575456,0.522232696,
-9.52226329e-17,4.01862285e-18,4.85722573e-16,-0.385231782,4.33680869e-16,-5.21089197e-16,-1.37390099e-15,1.8375813,-7.94503352e-16,-0.0683575456,-0.522232696,0.0683575456,0.522232696,0.0683575456,0.522232696,-0.0683575456,-0.522232696,
2.62558316e-16,4.16649736e-16,-2.22044605e-16,3.98986399e-16,-0.385231782,-3.04895642e-16,2.91433544e-16,-7.11236625e-16,1.8375813,-0.0683575456,-0.522232696,0.0683575456,0.522232696,-0.0683575456,-0.522232696,0.0683575456,0.522232696,
0.0189158405,0.0212513743,-0.0527255249,-0.0527255249,-0.0527255249,-0.157316294,-0.0683575456,-0.0683575456,-0.0683575456,1.28587508,-0.395893755,0.0128648697,0.0422297643,0.0128648697,0.0422297643,0.0128648697,0.0422297643,
0.016640171,0.142018507,0.0677106203,0.0677106203,0.0677106203,-0.871791449,-0.522232696,-0.522232696,-0.522232696,-0.395893755,2.22739582,0.0422297643,-0.164382049,0.0422297643,-0.164382049,0.0422297643,-0.164382049,
0.0189158405,0.0212513743,-0.0527255249,0.0527255249,0.0527255249,-0.157316294,-0.0683575456,0.0683575456,0.0683575456,0.0128648697,0.0422297643,1.28587508,-0.395893755,0.0128648697,0.0422297643,0.0128648697,0.0422297643,
0.016640171,0.142018507,0.0677106203,-0.0677106203,-0.0677106203,-0.871791449,-0.522232696,0.522232696,0.522232696,0.0422297643,-0.164382049,-0.395893755,2.22739582,0.0422297643,-0.164382049,0.0422297643,-0.164382049,
0.0189158405,0.0212513743,0.0527255249,0.0527255249,-0.0527255249,-0.157316294,0.0683575456,0.0683575456,-0.0683575456,0.0128648697,0.0422297643,0.0128648697,0.0422297643,1.28587508,-0.395893755,0.0128648697,0.0422297643,
0.016640171,0.142018507,-0.0677106203,-0.0677106203,0.0677106203,-0.871791449,0.522232696,0.522232696,-0.522232696,0.0422297643,-0.164382049,0.0422297643,-0.164382049,-0.395893755,2.22739582,0.0422297643,-0.164382049,
0.0189158405,0.0212513743,0.0527255249,-0.0527255249,0.0527255249,-0.157316294,0.0683575456,-0.0683575456,0.0683575456,0.0128648697,0.0422297643,0.0128648697,0.0422297643,0.0128648697,0.0422297643,1.28587508,-0.395893755,
0.016640171,0.142018507,-0.0677106203,0.0677106203,-0.0677106203,-0.871791449,0.522232696,-0.522232696,0.522232696,0.0422297643,-0.164382049,0.0422297643,-0.164382049,0.0422297643,-0.164382049,-0.395893755,2.22739582;
  
  ConvergenceAcc d;
  d.setSqrtOverlap(&Smonehalf);
  d.SolveFockmatrix(orb.MOEnergies(),orb.MOCoefficients(),H);
  
  Eigen::VectorXd MOEnergies_ref=Eigen::VectorXd::Zero(17);
  MOEnergies_ref<<-4.29332753,-3.99146858,-3.99146858,-3.99146858,-2.69172222,-2.69172222,-2.69172222,-2.61521973,-2.19277057,-2.19277057,-2.19277057,-1.75923211,-1.46241535,-1.46241535,-1.46241535,-1.21150295,14.6697624;
  bool check_moenergies=orb.MOEnergies().isApprox(MOEnergies_ref,00001);
  
  BOOST_CHECK_EQUAL(check_moenergies, 1);
  
  Eigen::MatrixXd dmat=orb.DensityMatrixGroundState();
 
          
   Eigen::MatrixXd dmat_ref=Eigen::MatrixXd::Zero(17,17);       
 dmat_ref<<0.00157507,0.0337454,4.48905e-16,-5.93152e-16,7.87133e-17,0.030876,2.51254e-16,-1.49094e-16,5.77899e-17,0.00415998,-0.00445632,0.00415998,-0.00445632,0.00415998,-0.00445632,0.00415998,-0.00445632,
0.0337454,0.722983,2.66427e-15,-4.44783e-15,3.45846e-16,0.661507,4.39854e-15,-2.02475e-15,1.04832e-15,0.0891262,-0.095475,0.0891262,-0.095475,0.0891262,-0.095475,0.0891262,-0.095475,
4.48905e-16,2.66427e-15,1.52199,2.88658e-15,2.09034e-15,-7.94212e-15,0.215492,2.8727e-15,-1.40513e-15,0.141933,-0.0402359,0.141933,-0.0402359,-0.141933,0.0402359,-0.141933,0.0402359,
-5.93152e-16,-4.44783e-15,2.88658e-15,1.52199,-2.31759e-15,9.21105e-15,-2.22045e-15,0.215492,1.6263e-15,0.141933,-0.0402359,-0.141933,0.0402359,-0.141933,0.0402359,0.141933,-0.0402359,
7.87133e-17,3.45846e-16,2.09034e-15,-2.31759e-15,1.52199,2.98902e-15,-2.04958e-15,4.79738e-15,0.215492,0.141933,-0.0402359,-0.141933,0.0402359,0.141933,-0.0402359,-0.141933,0.0402359,
0.030876,0.661507,-7.94212e-15,9.21105e-15,2.98902e-15,0.605259,2.55488e-15,2.7779e-17,1.33759e-15,0.0815477,-0.0873567,0.0815477,-0.0873567,0.0815477,-0.0873567,0.0815477,-0.0873567,
2.51254e-16,4.39854e-15,0.215492,-2.22045e-15,-2.04958e-15,2.55488e-15,0.0305108,3.29597e-17,-5.29036e-16,0.0200958,-0.00569686,0.0200958,-0.00569686,-0.0200958,0.00569686,-0.0200958,0.00569686,
-1.49094e-16,-2.02475e-15,2.8727e-15,0.215492,4.79738e-15,2.7779e-17,3.29597e-17,0.0305108,9.55941e-16,0.0200958,-0.00569686,-0.0200958,0.00569686,-0.0200958,0.00569686,0.0200958,-0.00569686,
5.77899e-17,1.04832e-15,-1.40513e-15,1.6263e-15,0.215492,1.33759e-15,-5.29036e-16,9.55941e-16,0.0305108,0.0200958,-0.00569686,-0.0200958,0.00569686,0.0200958,-0.00569686,-0.0200958,0.00569686,
0.00415998,0.0891262,0.141933,0.141933,0.141933,0.0815477,0.0200958,0.0200958,0.0200958,0.0506951,-0.0230264,-0.00224894,-0.00801753,-0.00224894,-0.00801753,-0.00224894,-0.00801753,
-0.00445632,-0.095475,-0.0402359,-0.0402359,-0.0402359,-0.0873567,-0.00569686,-0.00569686,-0.00569686,-0.0230264,0.0157992,-0.00801753,0.0115445,-0.00801753,0.0115445,-0.00801753,0.0115445,
0.00415998,0.0891262,0.141933,-0.141933,-0.141933,0.0815477,0.0200958,-0.0200958,-0.0200958,-0.00224894,-0.00801753,0.0506951,-0.0230264,-0.00224894,-0.00801753,-0.00224894,-0.00801753,
-0.00445632,-0.095475,-0.0402359,0.0402359,0.0402359,-0.0873567,-0.00569686,0.00569686,0.00569686,-0.00801753,0.0115445,-0.0230264,0.0157992,-0.00801753,0.0115445,-0.00801753,0.0115445,
0.00415998,0.0891262,-0.141933,-0.141933,0.141933,0.0815477,-0.0200958,-0.0200958,0.0200958,-0.00224894,-0.00801753,-0.00224894,-0.00801753,0.0506951,-0.0230264,-0.00224894,-0.00801753,
-0.00445632,-0.095475,0.0402359,0.0402359,-0.0402359,-0.0873567,0.00569686,0.00569686,-0.00569686,-0.00801753,0.0115445,-0.00801753,0.0115445,-0.0230264,0.0157992,-0.00801753,0.0115445,
0.00415998,0.0891262,-0.141933,0.141933,-0.141933,0.0815477,-0.0200958,0.0200958,-0.0200958,-0.00224894,-0.00801753,-0.00224894,-0.00801753,-0.00224894,-0.00801753,0.0506951,-0.0230264,
-0.00445632,-0.095475,0.0402359,-0.0402359,0.0402359,-0.0873567,0.00569686,-0.00569686,0.00569686,-0.00801753,0.0115445,-0.00801753,0.0115445,-0.00801753,0.0115445,-0.0230264,0.0157992;
 
  bool check_dmat = dmat.isApprox(dmat_ref,0.00001);
BOOST_CHECK_EQUAL(check_dmat, 1);


}

BOOST_AUTO_TEST_SUITE_END()
